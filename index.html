<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Battle</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        body {
            background-color: #0d1117;
            color: #e6e6e6;
            font-family: 'Orbitron', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            flex-direction: column;
            text-align: center;
        }
        canvas {
            background-color: #010409;
            border: 2px solid #238636;
            border-radius: 12px;
            box-shadow: 0 0 15px #238636;
            touch-action: none; /* Disable default touch actions */
        }
        .ui-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            padding: 20px;
            background: rgba(13, 17, 23, 0.9);
            border: 2px solid #238636;
            border-radius: 12px;
            box-shadow: 0 0 15px #238636;
            min-width: 300px;
            z-index: 2; /* Ensure it's above the canvas */
        }
        .hidden {
            display: none;
        }
        h1 {
            color: #238636;
            text-shadow: 0 0 8px #238636;
        }
        button {
            background-color: #238636;
            color: #e6e6e6;
            border: none;
            padding: 15px 30px;
            font-size: 1em;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 4px #1a5c2b;
        }
        button:hover {
            background-color: #2ea043;
            transform: translateY(-2px);
            box-shadow: 0 6px #1a5c2b;
        }
        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px #1a5c2b;
        }
        .progress-bar-container {
            width: 80%;
            height: 25px;
            background-color: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #238636;
        }
        .progress-bar {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #238636, #2ea043);
            transition: width 0.5s ease-in-out;
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: bold;
        }
        .health-bar-container {
            width: 150px;
            height: 15px;
            background-color: #333;
            border-radius: 8px;
            border: 2px solid #fff;
            overflow: hidden;
            box-shadow: 0 0 5px #fff;
        }
        .health-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff4c4c, #e60000);
            transition: width 0.2s linear;
        }
        .health-bar.player1 {
            background: linear-gradient(90deg, #4cff4c, #00e600);
        }
        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(13, 17, 23, 0.95);
            border: 2px solid #238636;
            border-radius: 12px;
            box-shadow: 0 0 15px #238636;
            padding: 30px;
            z-index: 10;
            text-align: center;
            max-width: 90%;
        }
        .input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        input[type="text"] {
            padding: 10px;
            border: 2px solid #238636;
            background-color: #010409;
            color: #e6e6e6;
            border-radius: 8px;
            font-family: 'Orbitron', sans-serif;
            text-align: center;
        }
        .question-box {
            padding: 20px;
            background: rgba(13, 17, 23, 0.9);
            border: 2px solid #238636;
            border-radius: 12px;
            margin-top: 20px;
        }
        .question-box p {
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        .question-box button {
            width: 100%;
            margin-top: 10px;
        }
        #high-scores-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        #high-scores-list li {
            background: #1a1a1a;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #238636;
        }

        .battle-ui {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1; /* Above canvas, below UI overlay */
        }
        .battle-ui-side {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .health-bar-bg {
            width: 200px;
            height: 25px;
            background: #333;
            border: 2px solid #238636;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        .player-health-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #4cff4c, #00e600);
            transition: width 0.5s ease-in-out;
        }
        .ai-health-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #ff4c4c, #e60000);
            transition: width 0.5s ease-in-out;
        }
        .battle-ui p {
            font-size: 1.2em;
            font-weight: bold;
            color: #238636;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
    </div>

    <div id="battle-ui" class="battle-ui hidden">
        <div class="battle-ui-side">
            <p>Player</p>
            <div class="health-bar-bg">
                <div id="playerHealthBar" class="player-health-bar"></div>
            </div>
        </div>
        <div class="battle-ui-side">
            <p>AI Bot</p>
            <div class="health-bar-bg">
                <div id="aiHealthBar" class="ai-health-bar"></div>
            </div>
        </div>
    </div>

    <div id="ui-overlay" class="ui-container">
        <div id="main-menu" class="screen">
            <h1>Robot Battle</h1>
            <p>Ready to fight?</p>
            <button id="newGameBtn">New Game</button>
        </div>

        <div id="quiz-menu" class="screen hidden">
            <h1>Problem Solving</h1>
            <div id="robotProgressContainer" class="progress-bar-container">
                <div id="robotProgressBar" class="progress-bar"></div>
            </div>
            <div id="questionBox" class="question-box">
                <p id="questionText"></p>
                <button id="optionA" class="option-btn"></button>
                <button id="optionB" class="option-btn"></button>
                <button id="optionC" class="option-btn"></button>
                <button id="optionD" class="option-btn"></button>
            </div>
        </div>

        <div id="battle-menu" class="screen hidden">
            <h1>FIGHT!</h1>
        </div>

        <div id="game-over-menu" class="screen hidden">
            <h1 id="gameOverText"></h1>
            <p id="finalHealthText"></p>
            <button id="playAgainBtn">Play Again</button>
        </div>
    </div>

    <div id="alert-modal" class="modal hidden">
        <p id="alert-message"></p>
        <button id="alert-close-btn">OK</button>
    </div>

    <script>
        // Game State and Variables
        let game = {
            state: 'menu'
        };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const uiOverlay = document.getElementById('ui-overlay');
        const battleUI = document.getElementById('battle-ui');
        const screens = document.querySelectorAll('.screen');
        const alertModal = document.getElementById('alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const alertCloseBtn = document.getElementById('alert-close-btn');
        
        // UI elements
        const newGameBtn = document.getElementById('newGameBtn');
        const questionText = document.getElementById('questionText');
        const optionBtns = document.querySelectorAll('.option-btn');
        const progressBar = document.getElementById('robotProgressBar');
        const gameOverText = document = document.getElementById('gameOverText');
        const finalHealthText = document.getElementById('finalHealthText');
        const playAgainBtn = document.getElementById('playAgainBtn');

        const playerHealthBar = document.getElementById('playerHealthBar');
        const aiHealthBar = document.getElementById('aiHealthBar');
        
        const ROBOT_HEIGHT = 100;
        const ROBOT_WIDTH = 60;
        const GROUND_Y_OFFSET = 0.8; // 80% of canvas height

        const quizQuestions = [
            {
                question: "Math: What is the sum of the prime numbers between 10 and 20?",
                options: ["28", "37", "41", "48"],
                answer: "41",
                part: "left_arm"
            },
            {
                question: "Science: What process do plants use to make their own food?",
                options: ["Respiration", "Photosynthesis", "Digestion", "Transpiration"],
                answer: "Photosynthesis",
                part: "right_arm"
            },
            {
                question: "Math: A rectangular field is 15m long and 8m wide. What is its perimeter?",
                options: ["23m", "46m", "120m", "42m"],
                answer: "46m",
                part: "left_leg"
            },
            {
                question: "Science: Which state of matter has a fixed shape and volume?",
                options: ["Solid", "Liquid", "Gas", "Plasma"],
                answer: "Solid",
                part: "right_leg"
            },
            {
                question: "Math: Find the value of 5 x (12 - 7) + 3.",
                options: ["28", "38", "50", "13"],
                answer: "28",
                part: "torso"
            },
            {
                question: "Science: What is the main source of energy for the water cycle?",
                options: ["Wind", "Moonlight", "Sunlight", "Gravity"],
                answer: "Sunlight",
                part: "head"
            },
        ];

        let currentQuestionIndex = 0;
        const partsToComplete = quizQuestions.length;
        
        const PLAYER_STATE = {
            id: '',
            x: 0,
            y: 0,
            health: 100,
            readiness: 0,
            parts: [],
            isAttacking: false,
            lastAttackTime: 0,
            yVelocity: 0,
            isJumping: false,
            isHit: false,
            hitTimer: null
        };

        let player1 = {...PLAYER_STATE, id: 'player1'};
        let aiBot = {...PLAYER_STATE, id: 'aiBot'};

        const keys = {};

        function showScreen(screenId) {
            screens.forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            
            // Manage UI visibility based on game state
            if (screenId === 'battle-menu') {
                uiOverlay.classList.add('hidden');
                battleUI.classList.remove('hidden');
            } else {
                uiOverlay.classList.remove('hidden');
                battleUI.classList.add('hidden');
            }
        }
        
        function showAlert(message) {
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
        }

        function resizeCanvas() {
            const container = document.getElementById('game-container');
            const aspectRatio = 16 / 9;
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;

            if (screenWidth / screenHeight > aspectRatio) {
                canvas.height = screenHeight * 0.8;
                canvas.width = canvas.height * aspectRatio;
            } else {
                canvas.width = screenWidth * 0.9;
                canvas.height = canvas.width / aspectRatio;
            }

            player1.x = canvas.width / 4;
            aiBot.x = canvas.width * 3 / 4;
            player1.y = canvas.height * GROUND_Y_OFFSET - ROBOT_HEIGHT;
            aiBot.y = canvas.height * GROUND_Y_OFFSET - ROBOT_HEIGHT;
        }

        function startGame() {
            game.state = 'quiz';
            resetGame();
            showScreen('quiz-menu');
            loadQuestion();
        }

        function updateHealthBars() {
            playerHealthBar.style.width = `${player1.health}%`;
            aiHealthBar.style.width = `${aiBot.health}%`;
        }

        // This function loads the next question from the quizQuestions array.
        function loadQuestion() {
            if (currentQuestionIndex < quizQuestions.length) {
                const q = quizQuestions[currentQuestionIndex];
                questionText.textContent = q.question;
                
                const options = [...q.options];
                options.sort(() => Math.random() - 0.5);

                // Populate the buttons with the shuffled options
                for(let i = 0; i < optionBtns.length; i++) {
                    optionBtns[i].textContent = options[i];
                }
            } else {
                player1.readiness = 100;
                aiBot.readiness = 100;
                game.state = 'battle';
                showAlert("Your robot is 100% ready! Entering the fighting arena!");
                setTimeout(() => {
                    showScreen('battle-menu');
                    updateHealthBars();
                }, 2000);
            }
        }

        function checkAnswer(selectedAnswer) {
            const q = quizQuestions[currentQuestionIndex];
            if (selectedAnswer === q.answer) {
                showAlert("Correct! You earned a robot part!");
                player1.parts.push(q.part);
                player1.readiness = Math.round((player1.parts.length / partsToComplete) * 100);
                progressBar.style.width = `${player1.readiness}%`;
                progressBar.textContent = `${player1.readiness}% ready`;
                currentQuestionIndex++;
                if (currentQuestionIndex < quizQuestions.length) {
                    setTimeout(loadQuestion, 1500);
                } else {
                    loadQuestion();
                }
            } else {
                showAlert("Incorrect. Try again!");
            }
        }
        
        function drawRobot(p) {
            ctx.fillStyle = p.isHit ? '#e60000' : (p.id === 'player1' ? '#238636' : '#2ea043');
            
            const bodyY = p.y;
            const bodyX = p.x;

            ctx.fillRect(bodyX, bodyY, ROBOT_WIDTH, ROBOT_HEIGHT * 0.4);
            ctx.fillRect(bodyX + ROBOT_WIDTH / 4, bodyY - 30, ROBOT_WIDTH / 2, 30);
            
            const punchOffset = p.isAttacking ? 20 : 0;

            if (p.parts.includes("left_arm")) {
                ctx.fillRect(bodyX - 20 - punchOffset, bodyY + 10, 20, 50);
            }
            if (p.parts.includes("right_arm")) {
                ctx.fillRect(bodyX + ROBOT_WIDTH + punchOffset, bodyY + 10, 20, 50);
            }
            if (p.parts.includes("left_leg")) {
                ctx.fillRect(bodyX + 5, bodyY + ROBOT_HEIGHT * 0.4, 20, 50);
            }
            if (p.parts.includes("right_leg")) {
                ctx.fillRect(bodyX + ROBOT_WIDTH - 25, bodyY + ROBOT_HEIGHT * 0.4, 20, 50);
            }
            if (p.parts.includes("torso")) {
                ctx.fillRect(bodyX - 10, bodyY + ROBOT_HEIGHT * 0.4 - 5, ROBOT_WIDTH + 20, 10);
            }
            if (p.parts.includes("head")) {
                ctx.fillRect(bodyX + 15, bodyY - 40, 30, 10);
            }
        }

        function handleInput(p) {
            const speed = 5;
            const jumpPower = -15;
            const groundY = canvas.height * GROUND_Y_OFFSET - ROBOT_HEIGHT;

            if (keys['ArrowLeft']) {
                p.x -= speed;
            }
            if (keys['ArrowRight']) {
                p.x += speed;
            }
            if (keys['ArrowUp'] && !p.isJumping) {
                p.yVelocity = jumpPower;
                p.isJumping = true;
            }
            p.x = Math.max(0, Math.min(canvas.width - ROBOT_WIDTH, p.x));
            
            if (p.isJumping) {
                p.y += p.yVelocity;
                p.yVelocity += 0.5; // Gravity
            }

            if (p.y >= groundY) {
                p.y = groundY;
                p.isJumping = false;
                p.yVelocity = 0;
            }
            
            if (keys[' '] && Date.now() - p.lastAttackTime > 500) {
                p.isAttacking = true;
                p.lastAttackTime = Date.now();
                setTimeout(() => p.isAttacking = false, 100);
            }
        }

        function handleAI() {
            const player = player1;
            const ai = aiBot;
            const distance = player.x - ai.x;
            const groundY = canvas.height * GROUND_Y_OFFSET - ROBOT_HEIGHT;

            if (ai.readiness < 100) {
                ai.readiness += 0.1;
                const parts = Math.floor(ai.readiness / (100 / partsToComplete));
                ai.parts = quizQuestions.slice(0, parts).map(q => q.part);
            }
            
            if (game.state === 'battle') {
                if (Math.abs(distance) > 100) {
                    ai.x += distance > 0 ? 2 : -2;
                } else {
                    if (Date.now() - ai.lastAttackTime > 1000) {
                        ai.isAttacking = true;
                        ai.lastAttackTime = Date.now();
                        setTimeout(() => ai.isAttacking = false, 100);
                    }
                }
                
                if (Math.random() < 0.005 && !ai.isJumping) {
                    ai.yVelocity = -15;
                    ai.isJumping = true;
                }

                if (ai.isJumping) {
                    ai.y += ai.yVelocity;
                    ai.yVelocity += 0.5;
                }

                if (ai.y >= groundY) {
                    ai.y = groundY;
                    ai.isJumping = false;
                    ai.yVelocity = 0;
                }
                
                ai.x = Math.max(0, Math.min(canvas.width - ROBOT_WIDTH, ai.x));
            }
        }

        function checkCollision(p1, p2) {
            const punchRange = 100;
            if (p1.isAttacking && Date.now() - p1.lastAttackTime < 100) {
                if (Math.abs(p1.x - p2.x) < punchRange && Math.abs(p1.y - p2.y) < ROBOT_HEIGHT) {
                    p2.health -= 10;
                    p2.isHit = true;
                    // Knockback effect
                    p2.x += (p1.x > p2.x) ? -10 : 10;
                    if (p2.hitTimer) clearTimeout(p2.hitTimer);
                    p2.hitTimer = setTimeout(() => p2.isHit = false, 200);
                    updateHealthBars();
                }
            }
        }

        function checkGameOver() {
            if (player1.health <= 0 || aiBot.health <= 0) {
                game.state = 'over';
                showScreen('game-over-menu');
                if (player1.health <= 0) {
                    gameOverText.textContent = `You Lost! The AI Bot won!`;
                } else {
                    gameOverText.textContent = `You Win! The AI Bot is defeated!`;
                }
                finalHealthText.textContent = `Final Health: You - ${Math.max(0, player1.health)}%, AI Bot - ${Math.max(0, aiBot.health)}%`;
            }
        }

        function resetGame() {
            game.state = 'menu';
            Object.assign(player1, PLAYER_STATE, { id: 'player1' });
            Object.assign(aiBot, PLAYER_STATE, { id: 'aiBot' });
            currentQuestionIndex = 0;
            progressBar.style.width = '0%';
            progressBar.textContent = '0% ready';
            updateHealthBars();
        }
        
        function animate() {
            requestAnimationFrame(animate);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (game.state === 'battle') {
                handleInput(player1);
                handleAI();
                checkCollision(player1, aiBot);
                checkCollision(aiBot, player1);

                drawRobot(player1);
                drawRobot(aiBot);
                
                checkGameOver();
            }
        }
        
        function setupEventListeners() {
            newGameBtn.addEventListener('click', startGame);
            
            optionBtns.forEach(btn => btn.addEventListener('click', (e) => checkAnswer(e.target.textContent)));
            
            alertCloseBtn.addEventListener('click', () => alertModal.classList.add('hidden'));

            playAgainBtn.addEventListener('click', () => {
                resetGame();
                showScreen('main-menu');
            });

            document.addEventListener('keydown', (e) => {
                keys[e.key] = true;
            });
            document.addEventListener('keyup', (e) => {
                keys[e.key] = false;
            });

            window.addEventListener('resize', resizeCanvas);
            
            resizeCanvas();
            animate();
        }

        window.onload = setupEventListeners;
    </script>
</body>
</html>
