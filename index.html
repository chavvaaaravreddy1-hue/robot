<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Battle</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        body {
            background-color: #0d1117;
            color: #e6e6e6;
            font-family: 'Orbitron', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            flex-direction: column;
            text-align: center;
        }
        canvas {
            background-color: #010409;
            border: 2px solid #238636;
            border-radius: 12px;
            box-shadow: 0 0 15px #238636;
            touch-action: none; /* Disable default touch actions */
        }
        .ui-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            padding: 20px;
            background: rgba(13, 17, 23, 0.9);
            border: 2px solid #238636;
            border-radius: 12px;
            box-shadow: 0 0 15px #238636;
            min-width: 300px;
            z-index: 2; /* Ensure it's above the canvas */
        }
        .hidden {
            display: none;
        }
        h1 {
            color: #238636;
            text-shadow: 0 0 8px #238636;
        }
        button {
            background-color: #238636;
            color: #e6e6e6;
            border: none;
            padding: 15px 30px;
            font-size: 1em;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 4px #1a5c2b;
        }
        button:hover {
            background-color: #2ea043;
            transform: translateY(-2px);
            box-shadow: 0 6px #1a5c2b;
        }
        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px #1a5c2b;
        }
        .progress-bar-container {
            width: 80%;
            height: 25px;
            background-color: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #238636;
        }
        .progress-bar {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #238636, #2ea043);
            transition: width 0.5s ease-in-out;
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: bold;
        }
        .health-bar-container {
            width: 150px;
            height: 15px;
            background-color: #333;
            border-radius: 8px;
            border: 2px solid #fff;
            overflow: hidden;
            box-shadow: 0 0 5px #fff;
        }
        .health-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff4c4c, #e60000);
            transition: width 0.2s linear;
        }
        .health-bar.player1 {
            background: linear-gradient(90deg, #4cff4c, #00e600);
        }
        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(13, 17, 23, 0.95);
            border: 2px solid #238636;
            border-radius: 12px;
            box-shadow: 0 0 15px #238636;
            padding: 30px;
            z-index: 10;
            text-align: center;
            max-width: 90%;
        }
        .input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        input[type="text"] {
            padding: 10px;
            border: 2px solid #238636;
            background-color: #010409;
            color: #e6e6e6;
            border-radius: 8px;
            font-family: 'Orbitron', sans-serif;
            text-align: center;
        }
        .question-box {
            padding: 20px;
            background: rgba(13, 17, 23, 0.9);
            border: 2px solid #238636;
            border-radius: 12px;
            margin-top: 20px;
        }
        .question-box p {
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        .question-box button {
            width: 100%;
            margin-top: 10px;
        }
        #high-scores-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        #high-scores-list li {
            background: #1a1a1a;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #238636;
        }

        .battle-ui {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1; /* Above canvas, below UI overlay */
        }
        .battle-ui-side {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .health-bar-bg {
            width: 200px;
            height: 25px;
            background: #333;
            border: 2px solid #238636;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        .player-health-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #4cff4c, #00e600);
            transition: width 0.5s ease-in-out;
        }
        .ai-health-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #ff4c4c, #e60000);
            transition: width 0.5s ease-in-out;
        }
        .battle-ui p {
            font-size: 1.2em;
            font-weight: bold;
            color: #238636;
        }
        
        #countdown-timer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5em;
            color: #238636;
            text-shadow: 0 0 15px #238636;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
    </div>

    <div id="battle-ui" class="battle-ui hidden">
        <div class="battle-ui-side">
            <p>Player</p>
            <div class="health-bar-bg">
                <div id="playerHealthBar" class="player-health-bar"></div>
            </div>
        </div>
        <div class="battle-ui-side">
            <p>AI Bot</p>
            <div class="health-bar-bg">
                <div id="aiHealthBar" class="ai-health-bar"></div>
            </div>
        </div>
    </div>

    <div id="ui-overlay" class="ui-container">
        <div id="main-menu" class="screen">
            <h1>Robot Battle</h1>
            <p>Ready to fight?</p>
            <button id="answerQuestionsBtn">Answer Questions</button>
            <button id="enterArenaBtn">Enter Arena</button>
        </div>

        <div id="quiz-menu" class="screen hidden">
            <h1>Problem Solving</h1>
            <div id="robotProgressContainer" class="progress-bar-container">
                <div id="robotProgressBar" class="progress-bar"></div>
            </div>
            <div id="questionBox" class="question-box">
                <p id="questionText"></p>
                <button id="optionA" class="option-btn"></button>
                <button id="optionB" class="option-btn"></button>
                <button id="optionC" class="option-btn"></button>
                <button id="optionD" class="option-btn"></button>
            </div>
        </div>
        
        <div id="game-over-menu" class="screen hidden">
            <h1 id="gameOverText"></h1>
            <p id="finalHealthText"></p>
            <button id="playAgainBtn">Play Again</button>
        </div>
    </div>

    <div id="alert-modal" class="modal hidden">
        <p id="alert-message"></p>
        <button id="alert-close-btn">OK</button>
    </div>
    
    <div id="countdown-timer" class="hidden"></div>

    <script>
        // Game State and Variables
        let game = {
            state: 'menu'
        };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const uiOverlay = document.getElementById('ui-overlay');
        const battleUI = document.getElementById('battle-ui');
        const screens = document.querySelectorAll('.screen');
        const alertModal = document.getElementById('alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const alertCloseBtn = document.getElementById('alert-close-btn');
        const countdownTimer = document.getElementById('countdown-timer');
        
        // UI elements
        const answerQuestionsBtn = document.getElementById('answerQuestionsBtn');
        const enterArenaBtn = document.getElementById('enterArenaBtn');
        const questionText = document.getElementById('questionText');
        const optionBtns = document.querySelectorAll('.option-btn');
        const progressBar = document.getElementById('robotProgressBar');
        const gameOverText = document.getElementById('gameOverText');
        const finalHealthText = document.getElementById('finalHealthText');
        const playAgainBtn = document.getElementById('playAgainBtn');

        const playerHealthBar = document.getElementById('playerHealthBar');
        const aiHealthBar = document.getElementById('aiHealthBar');
        
        const ROBOT_HEIGHT = 70; // Smaller size
        const ROBOT_WIDTH = 40; // Smaller size

        // Hardcoded quiz questions to avoid API dependency
        let quizQuestions = [
            {
                "question": "What is the process by which a plant makes its food?",
                "options": ["Respiration", "Transpiration", "Photosynthesis", "Germination"],
                "answer": "Photosynthesis",
                "part": "left_arm"
            },
            {
                "question": "Which planet is known as the 'Red Planet'?",
                "options": ["Venus", "Mars", "Jupiter", "Saturn"],
                "answer": "Mars",
                "part": "right_arm"
            },
            {
                "question": "How many sides does a hexagon have?",
                "options": ["4", "5", "6", "7"],
                "answer": "6",
                "part": "left_leg"
            },
            {
                "question": "What is the largest organ of the human body?",
                "options": ["Heart", "Brain", "Liver", "Skin"],
                "answer": "Skin",
                "part": "right_leg"
            },
            {
                "question": "What is the product of 12 x 12?",
                "options": ["120", "132", "144", "156"],
                "answer": "144",
                "part": "torso"
            },
            {
                "question": "What is the main source of energy for the Earth?",
                "options": ["Moon", "Sun", "Stars", "Wind"],
                "answer": "Sun",
                "part": "head"
            }
        ];

        const robotParts = ["left_arm", "right_arm", "left_leg", "right_leg", "torso", "head"];
        const partsToComplete = 6;
        let currentQuestionIndex = 0;
        
        const PLAYER_STATE = {
            id: '',
            x: 0,
            y: 0,
            health: 100,
            readiness: 0,
            parts: [],
            isAttacking: false,
            lastAttackTime: 0,
            isHit: false,
            hitTimer: null
        };

        let player1 = {...PLAYER_STATE, id: 'player1'};
        let aiBot = {...PLAYER_STATE, id: 'aiBot'};

        const keys = {};

        function showScreen(screenId) {
            screens.forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            
            // Manage UI visibility based on game state
            if (screenId === 'battle-menu') {
                uiOverlay.classList.add('hidden');
                battleUI.classList.remove('hidden');
            } else {
                uiOverlay.classList.remove('hidden');
                battleUI.classList.add('hidden');
            }
        }
        
        function showAlert(message) {
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
        }

        function resizeCanvas() {
            const container = document.getElementById('game-container');
            const aspectRatio = 16 / 9;
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;

            if (screenWidth / screenHeight > aspectRatio) {
                canvas.height = screenHeight * 0.8;
                canvas.width = canvas.height * aspectRatio;
            } else {
                canvas.width = screenWidth * 0.9;
                canvas.height = canvas.width / aspectRatio;
            }

            // Place robots in opposite corners
            player1.x = 50;
            player1.y = canvas.height - ROBOT_HEIGHT - 50;
            
            aiBot.x = canvas.width - ROBOT_WIDTH - 50;
            aiBot.y = 50;
        }

        function startGame() {
            resetGame();
            resizeCanvas();
            game.state = 'quiz';
            showScreen('quiz-menu');
            loadQuestion();
        }

        function startArenaImmediately() {
            resetGame();
            resizeCanvas();
            startBattleCountdown();
        }

        function startBattleCountdown() {
            uiOverlay.classList.add('hidden');
            countdownTimer.classList.remove('hidden');
            let count = 3;
            countdownTimer.textContent = count;

            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownTimer.textContent = count;
                } else if (count === 0) {
                    countdownTimer.textContent = 'FIGHT!';
                } else {
                    clearInterval(timer);
                    countdownTimer.classList.add('hidden');
                    game.state = 'battle';
                    showScreen('battle-menu');
                    player1.readiness = 100;
                    aiBot.readiness = 100;
                    player1.health = 100;
                    aiBot.health = 100;
                    player1.parts = [...robotParts];
                    aiBot.parts = [...robotParts];
                    updateHealthBars();
                }
            }, 1000);
        }

        function updateHealthBars() {
            playerHealthBar.style.width = `${player1.health}%`;
            aiHealthBar.style.width = `${aiBot.health}%`;
        }

        function loadQuestion() {
            if (currentQuestionIndex < quizQuestions.length) {
                const q = quizQuestions[currentQuestionIndex];
                questionText.textContent = q.question;
                
                const options = [...q.options];
                options.sort(() => Math.random() - 0.5);

                for(let i = 0; i < optionBtns.length; i++) {
                    optionBtns[i].textContent = options[i];
                }
            } else {
                player1.readiness = 100;
                aiBot.readiness = 100;
                game.state = 'battle';

                player1.health = 100;
                aiBot.health = 100;

                startBattleCountdown();
            }
        }

        function checkAnswer(selectedAnswer) {
            const q = quizQuestions[currentQuestionIndex];
            if (selectedAnswer === q.answer) {
                showAlert("Correct! You earned a robot part!");
                player1.parts.push(q.part);
                player1.readiness = Math.round((player1.parts.length / partsToComplete) * 100);
                progressBar.style.width = `${player1.readiness}%`;
                progressBar.textContent = `${player1.readiness}% ready`;
                currentQuestionIndex++;
                if (currentQuestionIndex < quizQuestions.length) {
                    setTimeout(loadQuestion, 1500);
                } else {
                    loadQuestion();
                }
            } else {
                showAlert("Incorrect. Try again!");
            }
        }
        
        function drawRobot(p) {
            // Main body with glowing effect
            const glowColor = p.id === 'player1' ? '#4cff4c' : '#ff4c4c';
            ctx.shadowColor = p.isHit ? '#e60000' : glowColor;
            ctx.shadowBlur = 15;
            ctx.fillStyle = p.isHit ? '#e60000' : (p.id === 'player1' ? '#238636' : '#2ea043');
            ctx.fillRect(p.x, p.y, ROBOT_WIDTH, ROBOT_HEIGHT);
            ctx.shadowBlur = 0;
            
            // Head
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(p.x + ROBOT_WIDTH * 0.25, p.y - 20, ROBOT_WIDTH * 0.5, 20);
            
            // Shoulders and hips
            ctx.fillStyle = '#2d2d2d';
            ctx.fillRect(p.x - 10, p.y + 10, ROBOT_WIDTH + 20, 10);
            ctx.fillRect(p.x - 10, p.y + ROBOT_HEIGHT - 20, ROBOT_WIDTH + 20, 10);
            
            // Add a small antenna
            ctx.fillStyle = p.isHit ? '#e60000' : (p.id === 'player1' ? '#238636' : '#2ea043');
            ctx.fillRect(p.x + ROBOT_WIDTH / 2 - 2, p.y - 30, 4, 10);
            
            // Punching effect
            const punchOffset = p.isAttacking ? 20 : 0;
            const direction = (p.id === 'player1') ? 1 : -1;
            
            if (p.parts.includes("left_arm")) {
                ctx.fillStyle = '#2d2d2d';
                ctx.fillRect(p.x - 10 - punchOffset * direction, p.y + 10, 10, 50);
            }
            if (p.parts.includes("right_arm")) {
                ctx.fillStyle = '#2d2d2d';
                ctx.fillRect(p.x + ROBOT_WIDTH + punchOffset * direction, p.y + 10, 10, 50);
            }
            if (p.parts.includes("left_leg")) {
                ctx.fillStyle = '#2d2d2d';
                ctx.fillRect(p.x + 5, p.y + ROBOT_HEIGHT, 15, 50);
            }
            if (p.parts.includes("right_leg")) {
                ctx.fillStyle = '#2d2d2d';
                ctx.fillRect(p.x + ROBOT_WIDTH - 20, p.y + ROBOT_HEIGHT, 15, 50);
            }
            if (p.parts.includes("torso")) {
                ctx.fillStyle = p.isHit ? '#e60000' : (p.id === 'player1' ? '#238636' : '#2ea043');
                ctx.fillRect(p.x, p.y + 40, ROBOT_WIDTH, 20);
            }
            if (p.parts.includes("head")) {
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(p.x + ROBOT_WIDTH * 0.25, p.y - 20, ROBOT_WIDTH * 0.5, 20);
            }
        }

        function handleInput(p) {
            const speed = 5;

            if (keys['ArrowLeft']) {
                p.x -= speed;
            }
            if (keys['ArrowRight']) {
                p.x += speed;
            }
            if (keys['ArrowUp']) {
                p.y -= speed;
            }
            if (keys['ArrowDown']) {
                p.y += speed;
            }

            p.x = Math.max(0, Math.min(canvas.width - ROBOT_WIDTH, p.x));
            p.y = Math.max(0, Math.min(canvas.height - ROBOT_HEIGHT, p.y));
            
            if (keys[' '] && Date.now() - p.lastAttackTime > 500) {
                p.isAttacking = true;
                p.lastAttackTime = Date.now();
                setTimeout(() => p.isAttacking = false, 100);
            }
        }

        function handleAI() {
            const player = player1;
            const ai = aiBot;
            const distanceX = player.x - ai.x;
            const distanceY = player.y - ai.y;
            const aiSpeed = 1.5;
            
            if (ai.readiness < 100) {
                ai.readiness += 0.1;
                const parts = Math.floor(ai.readiness / (100 / partsToComplete));
                ai.parts = robotParts.slice(0, parts);
            }
            
            if (game.state === 'battle') {
                if (Math.abs(distanceX) > 5) {
                    ai.x += distanceX > 0 ? aiSpeed : -aiSpeed;
                }
                if (Math.abs(distanceY) > 5) {
                    ai.y += distanceY > 0 ? aiSpeed : -aiSpeed;
                } else {
                    if (Date.now() - ai.lastAttackTime > 1000) {
                        ai.isAttacking = true;
                        ai.lastAttackTime = Date.now();
                        setTimeout(() => ai.isAttacking = false, 100);
                    }
                }
                
                ai.x = Math.max(0, Math.min(canvas.width - ROBOT_WIDTH, ai.x));
                ai.y = Math.max(0, Math.min(canvas.height - ROBOT_HEIGHT, ai.y));
            }
        }

        function checkCollision(p1, p2) {
            const punchRange = 100;
            if (p1.isAttacking && Date.now() - p1.lastAttackTime < 100) {
                const dx = p1.x - p2.x;
                const dy = p1.y - p2.y;
                if (Math.abs(dx) < punchRange && Math.abs(dy) < ROBOT_HEIGHT) {
                    p2.health -= 10;
                    p2.isHit = true;
                    // Knockback effect
                    p2.x += (p1.x > p2.x) ? -10 : 10;
                    if (p2.hitTimer) clearTimeout(p2.hitTimer);
                    p2.hitTimer = setTimeout(() => p2.isHit = false, 200);
                    updateHealthBars();
                }
            }
        }

        function checkGameOver() {
            if (player1.health <= 0 || aiBot.health <= 0) {
                game.state = 'over';
                showScreen('game-over-menu');
                if (player1.health <= 0) {
                    gameOverText.textContent = `You Lost! The AI Bot won!`;
                } else {
                    gameOverText.textContent = `You Win! The AI Bot is defeated!`;
                }
                finalHealthText.textContent = `Final Health: You - ${Math.max(0, player1.health)}%, AI Bot - ${Math.max(0, aiBot.health)}%`;
            }
        }

        function resetGame() {
            Object.assign(player1, PLAYER_STATE, { id: 'player1' });
            Object.assign(aiBot, PLAYER_STATE, { id: 'aiBot' });
            currentQuestionIndex = 0;
            progressBar.style.width = '0%';
            progressBar.textContent = '0% ready';
            updateHealthBars();
        }
        
        function animate() {
            requestAnimationFrame(animate);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (game.state === 'battle') {
                handleInput(player1);
                handleAI();
                
                checkCollision(player1, aiBot);
                checkCollision(aiBot, player1);

                drawRobot(player1);
                drawRobot(aiBot);
                
                checkGameOver();
            }
        }
        
        function setupEventListeners() {
            answerQuestionsBtn.addEventListener('click', startGame);
            enterArenaBtn.addEventListener('click', startArenaImmediately);
            
            optionBtns.forEach(btn => btn.addEventListener('click', (e) => checkAnswer(e.target.textContent)));
            
            alertCloseBtn.addEventListener('click', () => alertModal.classList.add('hidden'));

            playAgainBtn.addEventListener('click', () => {
                game.state = 'menu';
                resetGame();
                resizeCanvas(); // Ensure positions are set for the next game
                showScreen('main-menu');
            });

            document.addEventListener('keydown', (e) => {
                keys[e.key] = true;
            });
            document.addEventListener('keyup', (e) => {
                keys[e.key] = false;
            });

            window.addEventListener('resize', resizeCanvas);
            
            resizeCanvas();
            animate();
        }

        window.onload = setupEventListeners;
    </script>
</body>
</html>
